name: QA Release
on:
    workflow_dispatch:
    push:
        branches:
            - main

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    release:
        permissions:
            contents: write
        runs-on: macos-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install stable toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  toolchain: stable
                  cache: true

            - name: Add macOS targets
              run: rustup target add aarch64-apple-darwin

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Check formatting
              run: pnpm format:check

            - name: Run ESLint
              run: pnpm lint

            - uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
                  APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
                  APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
                  APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
              with:
                  tauriScript: pnpm tauri
                  args: "--target aarch64-apple-darwin --config src-tauri/tauri.qa.conf.json"
                  tagName: qa-${{ github.sha }}
                  releaseName: "QA Build ${{ github.sha }}"
                  releaseBody: "QA build from commit ${{ github.sha }}"
                  releaseDraft: false
                  prerelease: true
